---
title: "Descriptive analysis"
author: "Jae Yeon Kim"
output:
html_document:
  toc: True
  theme: united
  number_sections: True
---

## Setup

```{r}

# if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  tidyverse, # for the tidyverse framework
  data.table, # for fast data wrangling
  patchwork, # for arranging ggplots
  here, # for reproducibility
  rvest, # for parsing html

  ### ggplot themes
  ggsci, # for pub-ready ggplots
  ggpubr, # for arranging ggplots
  ggthemes, # for fancy ggplot themes
  ggrepel, # for annotations

  ### Spatial analysis
  tidygeocoder, # for geocoding
  tigris, # for shape files
  usmap,
  maps, # maps
  mapproj,
  ggsn,
  tmap,
  tmaptools,
  sf,
  leaflet, # for interactive maps
  mapview, # to view and save map objects

  ### Time series analysis
  ggseas, # for seasonality adjustment
  fpp2, # for detecting seasonality in data

  ### Interactiev maps
  gganimate, # for animated maps
  gifski # for animated maps
)

# devtools::install_github("jaeyk/makereproducible")
library(makereproducible)

# Import R scripts

script_list <- list(
  make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/misc.r"),
  here("functions", "data_viz.r"),
  here("functions", "plot_us_heatmap.r"),
  here("functions", "stacked_bar_plot.R")
)

for (i in 1:length(script_list))
{
  source(script_list[[i]])
}

# for publication-friendly theme
theme_set(theme_pubr())
```

## Load files

N of Asian orgs: 299
N of Latino orgs: 519

```{r include=FALSE}

# Load files

asian_org <- read_csv(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/asian_orgs.csv"))

latino_org <- read_csv(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/latino_orgs.csv"))

asian_latino_census <- read_csv(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/asian_latino_census.csv"))

reagan <- read_csv(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/reagan_budget.csv"))

# Chinese service org

chinese_service_org <- read_csv(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/chinese_service_org.csv"))

# Mexican service org

mexican_service_org <- read_csv(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/mexican_service_org.csv"))
```

## Descriptive analysis

### Cross-sectional analysis

- [] Turn this into stacked bar plot. 

```{r}

org_df <- merge_by_group(asian_org, latino_org)

org_df <- org_df %>%
  mutate()
str_detect(org_df$Name, "asian|hispanic|latino|latina|raza|centro")

org_df$panethnic <- org_df %>% str_detct()

stacked_bar_plot(org_df, category, Type)

ggsave(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/asian_latino_orgs_n.png"), width = 10)
```

### Time-series analysis

#### Turning into time-series data

```{r}

# Fill 0 years to each subset
asian_cbo_year <- org_to_ts(asian_org %>% filter(Type == "CBO"))
asian_advo_year <- org_to_ts(asian_org %>% filter(Type == "Advocacy"))
asian_hybrid_year <- org_to_ts(asian_org %>% filter(Type == "Hybrid"))

latino_cbo_year <- org_to_ts(latino_org %>% filter(Type == "CBO"))
latino_advo_year <- org_to_ts(latino_org %>% filter(Type == "Advocacy"))
latino_hybrid_year <- org_to_ts(latino_org %>% filter(Type == "Hybrid"))

# Bind them
asian_year <- bind_rows(asian_cbo_year, asian_advo_year, asian_hybrid_year)
latino_year <- bind_rows(latino_cbo_year, latino_advo_year, latino_hybrid_year)

write_csv(asian_year, make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/processed_data/asian_year.csv"))

write_csv(latino_year, make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/processed_data/latino_year.csv"))
```

#### Plotting

```{r}

# Merge

merged <- bind_rows(
  mutate(asian_year, group = "Asian Americans"),
  mutate(latino_year, group = "Latinos")
)

# Plot

freq_sum <- merged %>%
  group_by(F.year, group, Type) %>%
  summarize(freq_sum = sum(Freq))

write_csv(freq_sum, make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/processed_data/freq_sum.csv"))

freq_sum %>%
  ggplot(aes(x = F.year, y = freq_sum)) +
  geom_point() +
  geom_line() +
  stat_stl(frequency = 4, s.window = "periodic", col = "blue", size = 1) +
  labs(
    title = " Grey: Raw trend \n Blue: Seaonality adjusted trend",
    x = "Year",
    y = "Number of organizations founded in each year"
  ) +
  facet_grid(Type ~ group) +
  xlim(c(1960, 2017)) +
  geom_vline(xintercept = c(1980), linetype = "dashed", col = "red") +
  annotate(
    geom = "text", x = 1972, y = 13, label = "War on Poverty",
    color = "red"
  ) +
  annotate(
    geom = "text", x = 1990, y = 13, label = "Post-Reagan period",
    color = "red"
  ) +
  scale_y_continuous(breaks = scales::pretty_breaks()) # integers

ggsave(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/org_founding_year.png"), height = 7, width = 12)
```

```{r}

panethnic <- freq_sum %>%
  filter(Type == "CBO") %>%
  ggplot(aes(x = F.year, y = freq_sum)) +
  geom_point() +
  geom_line() +
  labs(
    x = "Year", y = "Number of organizations founded in each year",
    title = "Panethnic organizations",
    subtitle = "Only included CBOs"
  ) +
  facet_grid(~group) +
  xlim(c(1960, 2017)) +
  geom_vline(xintercept = c(1980), linetype = "dashed", col = "red") +
  annotate(
    geom = "text", x = 1972, y = 13, label = "War on Poverty",
    color = "red"
  ) +
  annotate(
    geom = "text", x = 1990, y = 13, label = "Post-Reagan period",
    color = "red"
  ) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  ylim(c(0, 20))

ethnic <- bind_rows(
  mutate(chinese_service_org[, c("Name", "F.year")], group = "Chinese"),
  mutate(mexican_service_org[, c("Name", "F.year")], group = "Mexicans")
) %>%
  count(F.year, group) %>%
  ggplot(aes(x = F.year, y = n)) +
  geom_point() +
  geom_line() +
  labs(
    x = "Year", y = "Number of organizations founded in each year",
    title = "Ethnic organizations",
    subtitle = "Only included CBOs"
  ) +
  facet_grid(~group) +
  xlim(c(1960, 2017)) +
  geom_vline(xintercept = c(1980), linetype = "dashed", col = "red") +
  annotate(
    geom = "text", x = 1972, y = 13, label = "War on Poverty",
    color = "red"
  ) +
  annotate(
    geom = "text", x = 1990, y = 13, label = "Post-Reagan period",
    color = "red"
  ) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  ylim(c(0, 20))

panethnic / ethnic

ggsave(make_here("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/org_founding_year_combined.png"), height = 12, width = 13)
```

## Geospatial analysis

### Prep data 

```{r}

# register_google(key = "google api key")

# Subset data
## Asian

asian_org_dt <- data.table(asian_org)

asian_address <- asian_org_dt[F.year <= 1981, .(Address, F.year, Name, Type, States, County, City), ] %>% as.data.frame()

## Latino
latino_org_dt <- data.table(latino_org)

latino_address <- latino_org_dt[F.year <= 1981, .(Address, F.year, Name, Type, States, County, City), ] %>% as.data.frame()

org_address <- merge_by_group(asian_address, latino_address)

# Export
write_csv(org_address, here("processed_data", "org_address.csv"))

org_address <- read_csv(here("processed_data", "org_address.csv"))
```

### EDA
```{r}
org_address %>%
  count(States, sort = TRUE)
# California = 79, DC = 11, NY = 11

org_address %>%
  count(States, category, sort = TRUE)
# California - Asian = 43, California - Latino = 36

org_address %>%
  count(County, sort = TRUE)
# San Francisco 25, Los Angeles 19, Alameda 10, Sacramento 7

org_address %>%
  count(County, category, sort = TRUE)
# San Francisco - Asian = 20, Los Angeles - Asian = 10, Alameda - Asian = 5, Los Angeles - Latino = 9, Alameda - Asian 5, Alameda - Latino 5
```

### Import geocodes 

```{r}
# Fix the problematic addresses using Bing (done in Python)
lat_longs <- read_csv(here("processed_data", "org_lat_logs_fixed.csv"))[, -1]
```

### Making maps

#### Bubble map 

```{r}

# Join the two data
df <- left_join(org_address, lat_longs)

# Filter; Data ready
df <- df %>%
  filter(category == "Asian") %>%
  filter(!is.na(Address)) %>%
  filter(City == toupper("San Francisco"))

# Turn df into sf object
sites <- sf::st_as_sf(df,
  coords = c(
    "longtitude",
    "latitude"
  ),
  crs = 4326,
  agr = "identity"
)

# Import Bay Area shape file

bay_area_sf <- tigris::tracts(
  state = "CA",
  county = c("San Francisco")
)

# Crop the coordinates
cropped_sf <- st_crop(bay_area_sf,
  xmin = -122.48,
  xmax = -122.34,
  ymin = 37.76,
  ymax = 37.83
)

# For the test
# ggplot(bay_area_sf) +
#     geom_sf() +
#     ggplot2::coord_sf(xlim = c(-122.48, -122.34),
#                       ylim = c(37.76, 37.83)) +
#     theme_bw()

# Set the CRS
cropped_sf <- st_set_crs(cropped_sf, 4326)

# tmap approach
bay_tmap <-
  tm_shape(cropped_sf) +
  tm_borders() +
  tm_shape(sites) +
  tm_bubbles(
    size = 1,
    shapeNA = NA,
    col = "Type"
  ) +
  tm_layout(title = "Asian American organizations in San Francisco")

# to change color palette  tmaptools::palette_explorer()

# Static mode
tmap_mode("plot")

tmap_save(bay_tmap, file = here("outputs", "asian_org_map.png"))

# Interactive mode (leaflet)
lf <- tmap_leaflet(bay_tmap) %>%
  addTiles()

mapshot(lf,
  file = here("outputs", "asian_org_map_interactive.png"),
  remove_controls = c("homeButton", "layersControl")
)
```

#### Heatmap 

```{r}

# Load usmap
us_map <- usmap::us_map()

# Wrangle data
org_addr_rn <- org_address %>%
  rename(
    state = States,
    county = County
  ) %>%
  group_by(state, category) %>%
  count()

asian_map_df <- org_addr_rn %>% filter(category == "Asian")

latino_map_df <- org_addr_rn %>% filter(category != "Asian")
```

```{r}
# Map
asian_org_plot <- plot_us_heatmap(asian_map_df) + labs(title = "Asian American organizations")

latino_org_plot <- plot_us_heatmap(latino_map_df) + labs(title = "Latino organizations")

asian_org_plot + latino_org_plot

ggsave(here("outputs", "heatmaps.png"),
  width = 14,
  height = 7
)
```
