---
title: "Descriptive analysis"
author: "Jae Yeon Kim"
output:
html_document: 
  toc: true
  theme: united
---

## 0. Setup 

```{r}

# Clean up the environment

rm(list = ls())

# Import libraries (adapted from this link: https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        patchwork, # for arranging ggplots 
        ggpubr, # for arranging ggplots 
        ggthemes, # for fancy ggplot themes
        
        ### For making maps (https://geocompr.robinlovelace.net/adv-map.html#animated-maps)
        
        sf,
        raster,
        spData, 
        ggmap,
        maps,
        mapdata,
        tmap,     # for static and interactive maps
        leaflet,  # for interactive maps
        mapview,  # for interactive maps
        shiny,    # for web applications
        openintro, # for abbr2state function 
        
        ### Time series analysis 
        ggseas, # for seasonality adjustment
        fpp2, # for detecting seasonality in data 
        
        ### Interactiev maps 
        gganimate, # for animated maps
        gifski # for animated maps
)

```


## 1. Load files

N of Asian orgs: 299
N of Latino orgs: 519 

```{r include=FALSE}

# Load files

asian_org <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/asian_orgs.csv")

latino_org <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/latino_orgs.csv")

reagan <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/reagan_budget.csv")

# Chinese service org 

chinese_service_org <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/chinese_service_org.csv") 
  
# Mexican service org 

mexican_service_org <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/mexican_service_org.csv")

# Set theme 

source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/theme_publications.r")
source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/misc.r")

theme_set(theme_Publication(14))

```

## 2. Descriptive analysis

### 2.1. Cross-sectional analysis

```{r}

aa_org_n <- asian_org %>%
  dplyr::select(City, Type) %>%
  group_by(Type) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  ggplot(aes(x = reorder(Type, -n), y = n)) +
    geom_col() +
    theme_base() +
    labs(x = "Type", y = "Count", 
         title = "Asian organizations (N = 299)",
         subtitle = "Sorted by organization types")

latino_org_n <- latino_org %>%
  dplyr::select(City, Type) %>%
  group_by(Type) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  ggplot(aes(x = reorder(Type, -n), y = n)) +
    geom_col() +
    theme_base() +
    labs(x = "Type", y = "Count", 
         title = "Latino organizations (N = 519)",
         subtitle = "Sorted by organization types")

aa_org_n + latino_org_n

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/asian_latino_orgs_n.png", width = 10)

```
### 2.2. Time-series analysis

#### 2.2.1. Turning into time-series data 

```{r}

# Fill 0 years to each subset  
asian_cbo_year <- org_to_ts(asian_org %>% filter(Type == "CBO"))
asian_advo_year <- org_to_ts(asian_org %>% filter(Type == "Advocacy"))
asian_hybrid_year <- org_to_ts(asian_org %>% filter(Type == "Hybrid"))

latino_cbo_year <- org_to_ts(latino_org %>% filter(Type == "CBO"))
latino_advo_year <- org_to_ts(latino_org %>% filter(Type == "Advocacy"))
latino_hybrid_year <- org_to_ts(latino_org %>% filter(Type == "Hybrid"))

# Bind them 
asian_year <- bind_rows(asian_cbo_year, asian_advo_year, asian_hybrid_year)
latino_year <- bind_rows(latino_cbo_year, latino_advo_year, latino_hybrid_year)

write_csv(asian_year, "/home/jae/analyzing-asian-american-latino-civic-infrastructure/processed_data/asian_year.csv")
write_csv(latino_year, "/home/jae/analyzing-asian-american-latino-civic-infrastructure/processed_data/latino_year.csv")
```

#### 2.2.2. Plotting

```{r}

# Merge

merged <- bind_rows(mutate(asian_year, group = "Asian Americans"),
          mutate(latino_year, group = "Latinos"))

# Plot

freq_sum <- merged %>%
  group_by(F.year, group, Type) %>%
  summarize(freq_sum = sum(Freq))

write_csv(freq_sum, "/home/jae/analyzing-asian-american-latino-civic-infrastructure/processed_data/freq_sum.csv")

freq_sum %>%
  ggplot(aes(x = F.year, y = freq_sum)) +
    geom_point() +
    geom_line() +
    stat_stl(frequency = 4, s.window = "periodic", col = "blue", size = 1) +
    labs(title = " Grey: Raw trend \n Blue: Seaonality adjusted trend",
         x = "Year", 
         y = "Number of organizations founded in each year") +
    facet_grid(Type~group) +
    xlim(c(1960,2017)) +
    geom_vline(xintercept = c(1980), linetype = "dashed", col = "red") +
    annotate(geom="text", x = 1972, y = 13, label="War on Poverty",
              color="red") +
    annotate(geom="text", x = 1990, y = 13, label="Post-Reagan period",
              color="red") +
    scale_y_continuous(breaks = scales::pretty_breaks()) # integers

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/org_founding_year.png", height = 7, width = 12)

```

```{r}

panethnic <- freq_sum %>%
  filter(Type == "CBO") %>%
  ggplot(aes(x = F.year, y = freq_sum)) +
    geom_point() +
    geom_line() +
    labs(x = "Year", y = "Number of organizations founded in each year",
         title = "Panethnic organizations",
         subtitle = "Only included CBOs") +
    facet_grid(~group) +
    xlim(c(1960,2017))  +
    geom_vline(xintercept = c(1980), linetype = "dashed", col = "red") +
    annotate(geom="text", x = 1972, y = 13, label="War on Poverty",
              color="red") +
    annotate(geom="text", x = 1990, y = 13, label="Post-Reagan period",
              color="red") +
    scale_y_continuous(breaks = scales::pretty_breaks()) +
    ylim(c(0,20))

ethnic <- bind_rows(mutate(chinese_service_org[,c("Name", "F.year")], group = "Chinese"),
          mutate(mexican_service_org[,c("Name", "F.year")], group = "Mexicans")) %>% 
  count(F.year, group) %>%
  ggplot(aes(x = F.year, y = n)) +
    geom_point() +
    geom_line() +
    labs(x = "Year", y = "Number of organizations founded in each year",
         title = "Ethnic organizations",
         subtitle = "Only included CBOs") +     
    facet_grid(~group) +
    xlim(c(1960,2017))  +
    geom_vline(xintercept = c(1980), linetype = "dashed", col = "red") +
    annotate(geom="text", x = 1972, y = 13, label="War on Poverty",
              color="red") +
    annotate(geom="text", x = 1990, y = 13, label="Post-Reagan period",
              color="red") +
    scale_y_continuous(breaks = scales::pretty_breaks()) +
    ylim(c(0,20))

panethnic / ethnic

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/org_founding_year_combined.png", height = 12, width = 13)
```

### 2.3. Geospatial analysis 

I adapted code from [this](https://github.com/Robinlovelace/Creating-maps-in-R), [this](https://geocompr.robinlovelace.net/adv-map.html#animated-maps) and [this](https://d4tagirl.com/2017/05/how-to-plot-animated-maps-with-gganimate) site.

#### 2.3.1. Geocoding

```{r}

# Base map

us_states <- map_data("state")
us_county <- map_data("county")

# Get state names 

asian_org$region <- tolower(abbr2state(asian_org$States))
latino_org$region <- tolower(abbr2state(latino_org$States))

# Create fuctions 

## No year 

county_map <- function(data){
  data_county<- count(data, County)

  colnames(data_county)[1] <- "subregion"

  data_county$subregion <- as.character(data_county$subregion)
  data_county$subregion <- tolower(data_county$subregion)

  us_county_data <- left_join(us_county, data_county)
  return(us_county_data)
}

state_map <- function(data){
  data_state<- count(data, region)
  
  colnames(data_state)[1] <- "region"
  
  data_state$region <- as.character(data_state$region)
  data_state$region <- tolower(data_state$region)
  
  us_state_data <- left_join(us_states, data_state)
  return(us_state_data)
}

county_year_map <- function(data){
  data_county<- count(data, County, F.year)

  colnames(data_county)[1] <- "subregion"

  data_county$subregion <- as.character(data_county$subregion)
  data_county$subregion <- tolower(data_county$subregion)

  us_county_data <- left_join(us_county, data_county)
  return(us_county_data)
}

state_year_map <- function(data){
  data_state<- count(data, region, F.year)
  
  colnames(data_state)[1] <- "region"
  
  data_state$region <- as.character(data_state$region)
  data_state$region <- tolower(data_state$region)
  
  us_state_data <- left_join(us_states, data_state)
  return(us_state_data)
}

# Get state and county maps 

asian_state_map <- state_map(asian_org)
latino_state_map <- state_map(latino_org)

asian_county_map <- county_map(asian_org)
latino_county_map <- county_map(latino_org)

asian_county_year_map <- county_year_map(asian_org)
latino_county_year_map <- county_year_map(latino_org)

write_rds(asian_county_map, "/home/jae/analyzing-asian-american-latino-civic-infrastructure/processed_data/asian_county_map")
write_rds(latino_county_map, "/home/jae/analyzing-asian-american-latino-civic-infrastructure/processed_data/latino_county_map")

```

#### 2.3.2. Plotting  

##### 2.3.2.1. Maps 

```{r}

# Asian Americans

## State

asian_state <- ggplot(data = asian_state_map,
            aes(x = long, y = lat,
                group = group, fill = n))+
  geom_polygon(color = "gray10", size = 0.05) +
  labs(fill = "Number of organizations",
       title = "Asian American advocacy and CBOs",
       subtitle = "In States (2017)")

## County 

asian_county <- ggplot(data = asian_county_map,
            aes(x = long, y = lat,
                group = group, fill = n))+
  geom_polygon(color = "gray10", size = 0.05) +
  labs(fill = "Number of organizations",
       title = "Asian American advocacy and CBOs",
       subtitle = "In Counties (2017)")

# Latinos 

## State

latino_state <- ggplot(data = latino_state_map,
            aes(x = long, y = lat,
                group = group, fill = n))+
  geom_polygon(color = "gray10", size = 0.05) +
  labs(fill = "Number of organizations",
       subtitle = "In States (2017)",
       title = "Latino advocacy and CBOs") 

## County 

latino_county <- ggplot(data = latino_county_map,
            aes(x = long, y = lat,
                group = group, fill = n))+
  geom_polygon(color = "gray10", size = 0.05) +
  labs(fill = "Number of organizations",
       title = "Latino advocacy and CBOs",
       subtitle = "In Counties (2017)") 

ggarrange(asian_county, latino_county, common.legend = TRUE)

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/state_county_maps.png", width = 8)
```