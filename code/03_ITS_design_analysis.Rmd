---
title: "Interrupted time series design analysis"
author: "Jae Yeon Kim"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

## 0. Setup 

```{r}

# Clean up the environment

rm(list = ls())

# Import libraries (adapted from this link: https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        patchwork, # for arranging ggplots 
        ggpubr, # for arranging ggplots 
        ggthemes, # for fancy ggplot themes
        AER, # for applied econometrics
        olsrr, # for ols modeling
        outliers, # for outliers
        DMwR, # for data mining in R
        simpleboot, # for bootstrapping 
        broom, # for modeling
        plotrix, # for plotting functions
        ggfortify, # extended version of ggplot
        stargazer, # for model outputs 
        MASS, # for negative binominal regression
        pscl, # for zero-inflated poisson
        phenocamr, # for time series post-processing
        fANCOVA, # for nonparametric analysis of covariance
        RColorBrewer, # for color palettes 
        robustbase, # for robust linear modeling 
        lmtest, # for robustness checks
        sensemakr, # for sensitivity analysis
        tm, # for text analysis 
        quanteda, # for text analysis
        xts, # for time series objects 
        zoo, # for time series objects 
        forecast, # for ARIMA modeling
        tseries, # for stat tests for time series data 
        nlme, # for GLS
        changepoint # for change point detection
        )

```


## 1. Load files

```{r include=FALSE}

# Asian American and Latino communit-based and advocacy organizations 
asian_year <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/asian_orgs.csv")

latino_year <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/latino_orgs.csv")

# Administrative data 
reagan <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/reagan_budget.csv")

asian_latino_census <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/asian_latino_census.csv")                     

reagan_funding_1982 <- read.csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/reagan_funding_1982.csv")

medicare <- read.csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/medicare.csv")

# Party control data 
basic_party_covariates <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/basic_party_covariates.csv") 

# Community newspaper 
ie_data <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/ie_data.csv")

```


```{r include=FALSE}
# Set theme 

## Custom functions 
source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/misc.r")

## For ITS analysis
source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/visualize_its.r")

## For optimizing span parameter in loess 
source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/span_loess.r")

## For custom ggtheme 
source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/theme_publications.r")

theme_set(theme_Publication(14))

# Set preferred packages for conflicted functions 
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("annotate", "ggplot2")

```

## 2. Wrangle data 

### 2.1. Merge Asian American and Latino CBO and advocacy org 

```{r}

# Merge CBO and advocacy org data 
org_freq <- merge_by_group(asian_year, latino_year) %>% 
  count(F.year, Type, category) %>% 
  rename(Year = F.year, 
         Freq = n)

```

### 2.2. Census data 

```{r}

# Rename vars 
asian_latino_census <- asian_latino_census %>%
  rename(category = Group,
         pop_percentage = Percentage)

# Subset 
asian_latino_census <- subset(asian_latino_census, category != "Total")
asian_census <- subset(asian_latino_census, category == "Asian")
latino_census <- subset(asian_latino_census, category == "Latino")

# Fill years 

all_years <- seq(min(org_freq$Year, na.rm = TRUE), 
                 max(org_freq$Year, na.rm = TRUE), by = 1) # Create year sequence 

all_years <- data.frame(Year = all_years) # Turn it into a dataframe 

## Merge year sequence with the data 

org_freq <- all_years %>%
  merge(org_freq, by = "Year", all.x = TRUE)

asian_census <- all_years %>%
  merge(asian_census, by = "Year", all.x = TRUE)

latino_census <- all_years %>%
  merge(latino_census, by = "Year", all.x = TRUE)

# Recode 

asian_census$category[is.na(asian_census$category)] <- "Asian"
latino_census$category[is.na(latino_census$category)] <- "Latino"

for (i in seq(0, 60, by = 10)){
asian_census$pop_percentage[asian_census$Year %in% c((1960 + i):((1960 + i) + 9))] <-
asian_census$pop_percentage[asian_census$Year == (1960 + i)]
}

for (i in seq(0, 60, by = 10)){
latino_census$pop_percentage[latino_census$Year %in% c((1960 + i):((1960 + i) + 9))] <-
latino_census$pop_percentage[latino_census$Year == (1960 + i)]
}

# Merge pop data 

asian_latino_census <- merge_by_group(asian_census, latino_census)

```

### 2.3. Add covariates 

```{r}

reagan_org <- merge(org_freq, subset(reagan, Category == "ETES"), by = "Year")

reagan_org <- merge(reagan_org, asian_latino_census, by = c("Year", "category"))

colnames(basic_party_covariates)[1] <- "Year"

reagan_org <- merge(reagan_org, basic_party_covariates, by = "Year")

```

### 2.4. Additional tidying  

```{r}

# Mutate 

reagan_org <- reagan_org %>%
  mutate(intervention = ifelse(reagan_org$Year >= 1981, 1, 0),
         intervention = factor(intervention),
         category = factor(category),
         Type = factor(Type),
         Freq = as.integer(Freq))

# Select

reagan_org <- reagan_org %>% 
  select(Year, category, Type, Freq, Percentage, pop_percentage, presidency, senate, house, intervention)

```


## 3. Descriptive analysis 

### 3.1. Intervention 

#### 3.1.1. Overall trend 

```{r}

ggplot(reagan_org, aes(x = Year, y = Percentage)) +
  geom_point() +
  geom_line() +   
  geom_vline(xintercept = c(1981), col = "red", linetype ="dashed") +
  annotate("rect", xmin = 1964, xmax = 1981, ymin = 0, ymax = 7.2, alpha = .2) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  labs(title = "Budget for education, employment, and social service",
       y = "Percentage",
       x = "Year") +
  annotate(geom="text", x=1973, y=2, label="War on Poverty",
              color="red") +
  annotate(geom="text", x=1997, y=2, label="Post-Reagan period",
              color="red") +
  xlim(c(1964,2017))

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/reagan_budget_cut.png")

```

#### 3.1.2. Specific programs 

```{r}

cuts <- as_tibble(reagan_funding_1982) %>%
  ggplot(aes(x = fct_reorder(Name, -Outlays), y = Outlays*0.01)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "The impact of Reagan budget cut on community empowerment programs",
    subtitle = "Percentage difference between 1981 and 1982",
    x = "Grant names", y = "Percentage")

survived <- medicare %>%
  ggplot(aes(x = factor(year), y = amount)) +
  geom_vline(xintercept = factor(1981)) +
  geom_col() +
  labs(
    title = "The impact of Reagan budget cut on indiviual assistance programs",
    subtitle = "Total Medicare spending from 1970 to 2018 (in billion US dollars)",
    x = "Year",
    y = "Amount"
  )

cuts / survived 

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/grant_changes.png", width = 10, height = 8)

```

### 3.2. DV

```{r}

# Text data 
ie_processed <- ie_data[,-1] %>% # drop the first col
  ########################## Cleaning vars ##########################
  mutate(date = gsub(".*:", "", date) %>% str_trim(),
         date = gsub(",", "", date),
         date = as.Date(as.character(date), format = "%b%d%Y"),
         source = gsub(".*:", "", source) %>% str_trim(),
         author = gsub(".*:", "", author) %>% str_trim())

# Create a document term matrix based on a custom dictionary 
ie_dic <- dfm(corpus(ie_processed), 
              dictionary = dictionary(list(budget = 
                                      c("spending","grants","grant","funding","funds","fund"))))

# Add to the original data  
ie_processed$budget <- convert(ie_dic, to = "data.frame")[,2]

# Fill in 0 dates
all_dates <- seq(as.Date("1976/1/1"), as.Date("1987/12/31"), "day")

# Turn it into a dataframe 
all_dates <- data.frame(date = all_dates)
  
# Count by year and type
ie_processed %>% right_join(all_dates, by = "date")
ie_processed[is.na(ie_processed$budget)] <- 0

# Plot
ggplot(ie_processed) +
  geom_histogram(aes(x = date), binwidth = 0.1) + 
#  geom_vline(xintercept = c(as.Date("Jan 20, 1981", format = "%b%d%Y")), col = "red", linetype ="dashed") +
  geom_point(aes(x = date, y = budget), size = 2, alpha = 0.3) +
  geom_smooth(aes(x = date, y = budget), span = 0.1) +
  labs(x = "Date" , y = "Count",  
       title = "The frequency of budget related terms in a Reagan related article")  

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/dic_newspaper.png", width = 10)

```


## 4. Treating outliers 

```{r}

model <- lm(Freq ~ intervention + Percentage + pop_percentage + factor(category) + Type + presidency + senate + house, data = reagan_org)

ols_plot_cooksd_bar(model)

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/outliers_detected.png")
  
```

```{r}

# Detecting outliers 

cooksd <- cooks.distance(model)

influential <- as.numeric(names(cooksd)[(cooksd > 4*mean(cooksd, na.rm = TRUE))])

# Replace with NAs

reagan_org$Freq[influential] <- NA

# Imputation  

knnOutput <- knnImputation(reagan_org %>% mutate(category = factor(category),
                                                 Type = factor(Type)))

reagan_org$Freq <- round(knnOutput$Freq, 0)

reagan_org$Freq <- as.integer(reagan_org$Freq)
```

## 5. Statistical modeling 

### 5.1. Prediction comparisons 

```{r}

reagan_org$Type[reagan_org$Type == "Hybrid"] <- "CBO"

ols.model <- ols_its(reagan_org) + ggtitle("OLS") + labs(y = "Organizational founding") 

logged.ols.model <- ols_its(reagan_org %>% mutate(Freq = log(Freq))) + ggtitle("OLS with logged DV") + labs(y = "Organizational founding ") 
  
poisson.model <- ps_its(reagan_org) + ggtitle("Poisson") 

nb.model <- ps_its(reagan_org) + ggtitle("Negative binominal") 

ggarrange(ols.model, logged.ols.model, poisson.model, nb.model)

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/pred_plots.png")

```

### 5.2. Model comparisons 

```{r}

# test <- reagan_org

reagan_org <- subset(reagan_org, Type == "CBO")

lm.out <- lm(Freq ~ intervention + Percentage + pop_percentage + category + presidency + senate + house, data = reagan_org)

lm_log.out <- lm(log(Freq) ~ intervention + Percentage + pop_percentage + category + presidency + senate + house, data = reagan_org)
  
poisson.out <- glm(Freq ~ intervention + Percentage + pop_percentage + category + presidency + senate + house, data = reagan_org, family = "poisson")

nb.out <- glm.nb(Freq ~ intervention + Percentage + pop_percentage + category + presidency + senate + house, data = reagan_org)

stargazer(lm.out, lm_log.out, poisson.out, nb.out, 
          nb.out, type = "text")

```

#### 5.2.1. Overdispersion test

- Alpha is positive. Dispersion present.

```{r}

dispersiontest(poisson.out, trafo = 1)

```

#### 5.2.2. AIC 

```{r}
cat(paste0("OLS AIC:", AIC(lm.out), "\n",
       "Logged OLS AIC:", AIC(lm_log.out), "\n",
       "Poisson AIC:", AIC(poisson.out), "\n",
       "Negative Binominal AIC:", AIC(nb.out)))
```

#### 5.3.2. AIC in time 

```{r}

lm.AIC <-NA
lm_log.AIC <-NA
poisson.AIC <- NA
nb.AIC <- NA
year <-NA

for (i in c(0:38)){

lm.out <- lm(Freq ~ Percentage + pop_percentage + category, data = subset(reagan_org, Year <= 1970 + i))

lm_log.out <- lm(log(Freq) ~ Percentage + pop_percentage + category, data = subset(reagan_org, Year <= 1970 + i))
  
poisson.out <- glm(Freq ~ Percentage + pop_percentage + category, data = subset(reagan_org, Year <= 1970 + i), family = "poisson")

nb.out <- glm.nb(Freq ~ Percentage + pop_percentage + category, data = subset(reagan_org, Year <= 1970 + i))

lm.AIC[i] <- AIC(lm.out)
lm_log.AIC[i] <- AIC(lm_log.out)
poisson.AIC[i] <- AIC(poisson.out)
nb.AIC[i] <- AIC(nb.out)
  
year[i] <- 1970 + i
}

AICs <- data.frame("OLS" = lm.AIC,
                       "Logged_OLS" = lm_log.AIC,
                       "Poisson" = poisson.AIC,
                       "Negative_Binominal" = nb.AIC,
                       "Year" = year)

AICs %>%
  gather(Models, values, OLS:Negative_Binominal) %>%
  ggplot(aes(x = Year, y = values, col = Models)) +
  scale_color_brewer(type = "div", palette = "Set1") +
  geom_point() +
  geom_line() +
  labs(y = "AIC scores")

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/AIC_in_time.png",
              height = 6, width = 10)

```

### 5.3. Discontinuity in time

### 5.3.2. Coefficients 

```{r}

fed <- NA
pop <- NA
year <- NA

for (i in c(0:38)){
model <- lm(Freq ~ Percentage + pop_percentage + category, data = subset(reagan_org, Year <= 1970 + i))

fed[i] <- model$coefficients[3] %>% as.numeric()
pop[i] <- model$coefficients[4] %>% as.numeric()
year[i] <- 1970 + i}

for_loop <- data.frame("Fed_funding" = fed,
                       "Pop_growth" = pop,
                       "Year" = year)

fed_coef <- for_loop %>%
  ggplot(aes(x = Year, y = Fed_funding)) +
  geom_point() +
  geom_vline(xintercept = c(1980), linetype = "dashed", size = 1, color = "red") +
  labs(title = "Federal funding", 
       subtitle = "Only included CBOs", y = "OLS coefficients") 

pop_coef <- for_loop %>%
  ggplot(aes(x = Year, y = Pop_growth)) +
  geom_point() +
  geom_vline(xintercept = c(1980), linetype = "dashed", size = 1, color = "red") +
  labs(title = "Population growth", 
       subtitle = "Only included CBOs", y = "OLS coefficients") 

fed_coef + pop_coef 

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/reg_coeffs.png",
              height = 6, width = 10)

```

### 5.4. Bootstrapping 

```{r}

boot_ci <- function(i){

set.seed(1234)

stat = data.frame()
result = data.frame()
year = data.frame()

m = Boot(lm(Freq ~ Percentage + pop_percentage + category, data = subset(reagan_org, Year <= 1970 + i)), R = 500)

stat = rbind(stat, summary(m) %>% data.frame() %>% select(bootSE))

Year = rep(c(1970 + i), nrow(stat))

Names = c("Intercept", "Fed_SE", "Pop_SE", "Latino_SE")

result = cbind(stat, Year, Names)

rownames(result) <- NULL

result}

```

```{r}

cis <- data.frame()

for (i in c(1:38)){
  print(paste0(i, " iteration completed"))
  cis = rbind(cis, boot_ci(i))
}

colnames(cis)[1:2] <- c("SE", "Year")

cis_spread <- cis %>%
  spread(Names, SE) %>%
  select(-c(Intercept, Latino_SE))

boot_merged <- merge(cis_spread, for_loop)

fed_boot <- boot_merged %>%
  ggplot(aes(x = Year, y = Fed_funding, 
             ymax = Fed_funding + 2*Fed_SE, 
             ymin = Fed_funding - 2*Fed_SE)) +
  geom_pointrange() +
  labs(x = "Year", y = "OLS coefficients", 
       title = "Federal funding",
       subtitle = "With bootstrapped CIs") +
  geom_vline(xintercept = c(1980), linetype = "dashed", size = 1, color = "red") +          
  annotate("rect", xmin = 1964, xmax = 2010, ymin = -2, ymax = 0, alpha = .2)
  
pop_boot <- boot_merged %>%
  ggplot(aes(x = Year, y = Pop_growth, 
             ymax = Pop_growth + 2*Pop_SE, 
             ymin = Pop_growth - 2*Pop_SE)) +
  geom_pointrange() +
  labs(x = "Year", y = "OLS coefficients", 
       title = "Population growth",
       subtitle = "With bootstrapped CIs") +
  geom_vline(xintercept = c(1980), linetype = "dashed", size = 1, color = "red") +
  annotate("rect", xmin = 1964, xmax = 2010, ymin = -8, ymax = 0, alpha = .2)

fed_boot + pop_boot

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/boot_cis.png", 
       height = 6, width = 10)

```

### 5.5. Standard errors 

I adated some code from [this post](https://www.brodrigues.co/blog/2018-07-08-rob_stderr/).

```{r}

lm_log.out <- lm(log(Freq) ~ Percentage + pop_percentage + category + presidency + senate + house, data = subset(reagan_org, Year <= 1980))

```

#### 5.5.1. Heteroskedasticity 

- Null: the variance of residuals is constant = heteroskedasticity 

```{r}

lmtest::bptest(lm_log.out)

```

#### 5.5.2. Autocorrelation test 

- Null: the autocorrelation of residuals is 0. 

```{r}

lmtest::dwtest(lm_log.out)

```

- ACF shows an autoregressive pattern. 

```{r}

ggAcf(residuals(lm_log.out))

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/acf_test.png")

```

- Using HAC standard errors 

```{r}
# Coefficient summary using the Newey-West SE estimates
lm_new <- coeftest(lm_log.out, vcov = NeweyWest, prewhite = F, adjust = T)
  
```

#### 5.5.3. Outliers 

```{r}

lmrobfit <- lmrob(log(Freq) ~ Percentage + pop_percentage + category + presidency + senate + house, data = subset(reagan_org, Year <= 1980))

stargazer(lm_log.out, lm_new, lmrobfit, type = "text")

bind_rows(mutate(lm_log.out %>% tidy(), Type = "lm"), 
          mutate(lm_new %>% tidy(), Type = "HAC"))

          mutate(lmrobfit %>% tidy(), Type = "lmrob"))

lmrobfit %>% unlist() %>% select(contains("coefficients"))

```

### 5.6. Sensitivity analysis 

```{r}

lm.sense <- sensemakr(lm_log.out, treatment = "Percentage",
                         benchmark_covariates = c("pop_percentage", "categoryLatino"))
     
```