---
title: "Descriptive analysis"
author: "Jae Yeon Kim"
output:
html_document: 
  toc: true
  theme: united
---

## 0. Setup 

```{r}

# Clean up the environment

rm(list = ls())

# Import libraries (adapted from this link: https://stackoverflow.com/questions/4090169/elegant-way-to-check-for-missing-packages-and-install-them)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        patchwork, # for arranging ggplots 
        ggpubr, # for arranging ggplots 
        ggthemes, # for fancy ggplot themes
        AER, # for applied econometrics
        olsrr, # for ols modeling
        outliers, # for outliers
        DMwR, # for data mining in R
        simpleboot, # for bootstrapping 
        broom, # for modeling
        plotrix # for plotting functions
        )

```


## 1. Load files

```{r}

# Load files

asian_org <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/asian_orgs.csv")

latino_org <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/latino_orgs.csv")

reagan <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/reagan_budget.csv")

asian_latino_census <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/asian_latino_census.csv")                     

basic_party_covariates <- read_csv("/home/jae/analyzing-asian-american-latino-civic-infrastructure/raw_data/basic_party_covariates.csv") 

# Set theme 

source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/theme_publications.r")

source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/visualize_its.r")

source("/home/jae/analyzing-asian-american-latino-civic-infrastructure/functions/misc.r")

theme_set(theme_Publication())

```

## 2. Wrangle data 

```{r}

# Set dplyr 

conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")

# Merge

combined_org <- merge_by_group(asian_org, latino_org)

org_freq <- combined_org %>% count(F.year, Type, category) %>% rename(Freq=n)

# Column name change

colnames(org_freq)[1] <- "Year"

colnames(asian_latino_census)[2] <- "category"

colnames(asian_latino_census)[4] <- "pop_percentage"

colnames(basic_party_covariates)[1] <- "Year"

# Subset 

asian_latino_census <- subset(asian_latino_census, category != "Total")

asian_census <- subset(asian_latino_census, category == "Asian")

latino_census <- subset(asian_latino_census, category == "Latino")

# Fill years 

all_years <- seq(min(org_freq$Year), max(org_freq$Year), by = 1)

# Turn it into a dataframe 

all_years <- data.frame(Year = all_years)

# Filling the missing days 

org_freq <- all_years %>%
  merge(org_freq, by = "Year", all.x = TRUE)

asian_census <- all_years %>%
  merge(asian_census, by = "Year", all.x = TRUE)

latino_census <- all_years %>%
  merge(latino_census, by = "Year", all.x = TRUE)

# Recode 

asian_census$category[is.na(asian_census$category)] <- "Asian"

latino_census$category[is.na(latino_census$category)] <- "Latino"

for (i in seq(0, 60, by = 10)){
asian_census$pop_percentage[asian_census$Year %in% c((1960 + i):((1960 + i) + 9))] <-
asian_census$pop_percentage[asian_census$Year == (1960 + i)]
}

for (i in seq(0, 60, by = 10)){
latino_census$pop_percentage[latino_census$Year %in% c((1960 + i):((1960 + i) + 9))] <-
latino_census$pop_percentage[latino_census$Year == (1960 + i)]
}

# Merge pop data 

asian_latino_census <- merge_by_group(asian_census, latino_census)

reagan_org <- merge(org_freq, subset(reagan, Category == "ETES"), by = "Year")

reagan_org <- merge(reagan_org, asian_latino_census, by = c("Year", "category"))

# Recode 

reagan_org$Freq[reagan_org$Freq == 0] <- NA

# Mutate 

reagan_org <- merge(reagan_org, basic_party_covariates, by = "Year")

reagan_org <- reagan_org %>%
  mutate(intervention = ifelse(reagan_org$Year >= 1981, 1, 0),
         intervention = factor(intervention),
         category = factor(category),
         Type = factor(Type),
         Freq = as.integer(Freq))

# Select

reagan_org <- reagan_org %>% select(Year, category, Type, Freq, Percentage, pop_percentage, presidency, senate, house, intervention)

```


## 3. Descriptive analysis 

### 3.1. Intervention 

```{r}

ggplot(reagan_org, aes(x = Year, y = Percentage)) +
  geom_point() +
  geom_line() +   
  geom_vline(xintercept = c(1981), col = "red", linetype ="dashed") +
  ggplot2::annotate("rect", xmin = 1964, xmax = 1981, ymin = 0, ymax = 7.2, alpha = .2) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) + # scale parameter determines the digits
  ylab("Budget for education, employment, and social service") +
  annotate(geom="text", x=1973, y=2, label="War on Poverty",
              color="red") +
  annotate(geom="text", x=1997, y=2, label="Post-Reagan period",
              color="red") +
  xlim(c(1964,2017))

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/reagan_budget_cut.png")
```

### 3.2. DV

```{r}

model <- lm(Freq ~ intervention + Percentage + pop_percentage + factor(category) + Type + presidency + senate + house, data = reagan_org)

ols_plot_cooksd_bar(model)

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/outliers_detected.png")

```

## 4. Treating outliers 

I used the capping function comes from [this post](https://stackoverflow.com/questions/13339685/how-to-replace-outliers-with-the-5th-and-95th-percentile-values-in-r) at StackOverFlow.

```{r}

# Detecting outliers 

cooksd <- cooks.distance(model)

influential <- as.numeric(names(cooksd)[(cooksd > 4*mean(cooksd, na.rm = TRUE))])

# Replace with NAs

reagan_org$Freq[influential] <- NA

# Imputation  

knnOutput <- knnImputation(reagan_org %>% mutate(category = factor(category),
                                                 Type = factor(Type)))

reagan_org$Freq <- round(knnOutput$Freq, 0)
```

## 5. Statistical modeling 

### 5.1. OLS

```{r}

reagan_org$Type[reagan_org$Type == "Hybrid"] <- "CBO"

limited_model <- base_its(reagan_org) + ggtitle("Limited model (OLS)")

saturated_model <- full_its(reagan_org) + ggtitle("Saturated model (OLS)") 

limited_model + saturated_model

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/ols_plots.png", height = 5, width = 10)

```

### 5.2. Poisson 

```{r}

limited_model_ps <- base_its_ps(reagan_org) + ggtitle("Base model (Poisson)")

saturated_model_ps <- full_its_ps(reagan_org) + ggtitle("More covariates (Poisson)") 

limited_model_ps + saturated_model_ps

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/poisson_plots.png", height = 5, width = 10)

```

### 5.4. For loop 

```{r}

reagan_org <- subset(reagan_org, Type == "CBO")

fed <- NA
pop <- NA
year <- NA
glm_AIC <- NA

for (i in c(0:38)){
model <- lm(Freq ~ Percentage + pop_percentage + category, data = subset(reagan_org, Year <= 1970 + i))

fed[i] <- model$coefficients[3] %>% as.numeric()
pop[i] <- model$coefficients[4] %>% as.numeric()
year[i] <- 1970 + i
glm_AIC[i] <- AIC(model)}

for_loop <- data.frame("Fed_funding" = fed,
                       "Pop_growth" = pop,
                       "AIC" = glm_AIC,
                       "Year" = year)

for_loop %>%
  ggplot(aes(x = Year, y = AIC)) +
  geom_point() +
  labs(y = "AIC scores")

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/AIC_scores.png")

for_loop %>%
  gather(measures, values, c(Fed_funding, Pop_growth)) %>%
  ggplot(aes(x = Year, y = values)) +
  geom_point() +
  facet_wrap(~measures) +
  geom_vline(xintercept = c(1980), linetype = "dashed", size = 1, color = "red") +
  labs(title = "Changes in Regression Coefficients", 
       subtitle = "Only included CBOs", y = "OLS coefficients") +
  annotate("rect", xmin = 1964, xmax = 1980, ymin = -7, ymax = 4, alpha = .2)

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/reg_coeffs.png")

```


### 5.4. Bootstrapping 

```{r}

# For reproducibility
set.seed(1234)

stat <- data.frame()
result <- data.frame()
year <- NA

n = length(reagan_org$Year)
B = 30

for (i in c(0:5)){

for (draw in 1:B)
{

  boot.data = subset(reagan_org, Year <= 1970 + i)[sample(1:n, size = n, replace = TRUE), ]
  model = lm(Freq ~ Percentage + pop_percentage + category, data = boot.data) 
  df = data.frame(coef(model))
  stat = rbind(stat, df)

}
  year[i] = rep(c(1970 + i), length(stat$coef.model.))
  result = cbind(stat, year)
}

result

```

```{r}

for (i in c(0:38)){
lm_model <- lm(Freq ~ Percentage + pop_percentage + category, data = subset(reagan_org, Year <= 1970 + i))

lm_boot <- lm.boot(lm_model, R = 1)

tidied_boot <- samples(lm_boot, name = c("coef")) %>% tidy() 

summary_stat <- tidied_boot %>%
  gather(sims, values, c(2:ncol(.))) %>%
  group_by(.rownames) %>%
  summarize(mean = mean(values),
            se = std.error(values)) %>%
  filter(.rownames == "Percentage" | .rownames == "pop_percentage")

fed_mean[i] <- summary_stat[1,2]
fed_se[i] <- summary_stat[1,3]
pop_mean[i] <- summary_stat[2,2]
pop_se[i] <- summary_stat[2,3]
year[i] <- year[i] <- 1970 + i
}

boot_for_loop <- data.frame("Fed_mean" = fed_mean %>% unlist(),
                            "Fed_se" = fed_se %>% unlist(),
                            "Pop_mean" = pop_mean %>% unlist(),
                            "Pop_se" = pop_se %>% unlist(),
                            "Year" = year %>% unlist())

boot_for_loop %>%
  ggplot(aes(x = Year, y = Fed_mean, ymax = Fed_mean + 2*Fed_se, ymin = Fed_mean - 2*Fed_se)) +
  geom_point() +
  geom_vline(xintercept = c(1980), linetype = "dashed", size = 1, color = "red") +
  labs(title = "Federal funding", y = "Bootstrapped coefficients")

boot_for_loop %>%
  ggplot(aes(x = Year, y = Fed_mean, ymax = Fed_mean + 2*Fed_se, ymin = Fed_mean - 2*Fed_se)) +
  geom_point() +
  geom_vline(xintercept = c(1980), linetype = "dashed", size = 1, color = "red") +
  labs(title = "Population", y = "Bootstrapped coefficients")

```


```{r}
boot.coef <- data.frame("boot.coef" = boot.coef)

boot.mean <- mean(boot.coef$boot.coef)
boot.se <- sd(boot.coef$boot.coef)/sqrt(length(boot.coef$boot.coef))

ggplot(data = boot.coef, aes(x = boot.coef)) +
  geom_histogram(alpha = 0.3) +
  geom_vline(xintercept = c(mean(boot.coef) - 2*boot.se, mean(boot.coef)), col = "red", linetype ="dashed", size = 1) +
  labs(y = "Frequency", x = "Coefficients")
}

(visualize_boot(300) + ggtitle("R = 300")) + 
(visualize_boot(1000) + ggtitle("R = 1,000")) + 
(visualize_boot(10000) + ggtitle("R = 10,000"))  

ggsave("/home/jae/analyzing-asian-american-latino-civic-infrastructure/outputs/boot_sim.png", height = 5, width = 10)
```

## 7. Export LaTex tables
```{r}
# create regression tables
stargazer(pre_model2, pre_model3, pre_model4, 
          align = TRUE, 
          no.space = TRUE, 
          style = "apsr", 
          title = "Pre-Reagan regression results",
          covariate.labels = c("Federal funding (%)","Population (%)","Asian","Presidency"),
          dep.var.caption = "A Number of organizations",
          dep.var.labels = "Number of organizations",
          star.cutoffs = c(0.05, 0.01, 0.001))
```

```{r}
stargazer(post_model2, post_model3, post_model4, 
          align = TRUE, 
          no.space = TRUE, 
          style = "apsr", 
          title = "Post-Reagan regression results",
          covariate.labels = c("Population (%)","Federal funding (%)","Asian","Presidency","Senate","House"),
          dep.var.caption = "A Number of organizations",
          dep.var.labels = "Number of organizations",
          star.cutoffs = c(0.05, 0.01, 0.001))


```