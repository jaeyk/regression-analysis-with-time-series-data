---
title: "Additional robustness check"
author: "Jae Yeon Kim"
output:
html_document:
  toc: True
  theme: united
  number_sections: True
---

# Setup 

```{r, echo=FALSE}

# Import libraries 

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        patchwork, # for arranging ggplots 
        ggpubr, # for arranging ggplots 
        ggthemes, # for fancy ggplot themes
        broom, # for modeling
        here, # for reproducibility 
        magrittr, 
        nlme, # for GLS
        stargazer) 
        
# devtools::install_github("jaeyk/makereproducible")
library(makereproducible)

# Import R scripts

script_list <- list.files(paste0(here::here(), "/functions"),
  pattern = "*.r|*.R",
  full.names = TRUE
)

for (i in 1:length(script_list))
{
  source(script_list[[i]])
}

# for publication-friendly theme
theme_set(theme_pubr())

```
# Load files and wrangle data 

```{r}

wop_asian_city <- read_csv(here("raw_data", "asian_orgs.csv")) %>%
  filter(F.year <= 1981) %>%
  mutate(County = trimws(County)) %>%
  count(City, County, States, Type) 

wop_latino_city <- read_csv(here("raw_data", "latino_orgs.csv")) %>%
  filter(F.year <= 1981) %>%
  mutate(County = trimws(County)) %>%
  count(City, County, States, Type) 

oeo_census <- read.csv(here("processed_data" , "oeo_census.csv"))

historical_census_county <- read_csv(here("processed_data", "historical_census_county.csv")) %>%
  mutate(County = toupper(County)) %>%
  filter(County != "STATE TOTAL") %>%
  mutate(County = trimws(County)) 

historical_census_county <- add_state_abb(historical_census_county) %>%
    select(State, County, year, poverty_rate, pop_size, State_abb)

names(historical_census_county)

activism <- read.csv(here("processed_data", "activism.csv"))[,-1]

```

# Merge data

```{r}

df1 <- merge_by_group(wop_asian_city, wop_latino_city)

df1$Type[df1$Type == "Hybrid"] <- "CBO"

df2 <- df1 %>% left_join(activism)

df3 <- left_join(df2, oeo_census, by = c("County" , "States" , "City"))

unique(df3$City[df3$Activism == 1])
```

 [1] NA              "LOS ANGELES"  
 [3] "NEW YORK"      "OAKLAND"      
 [5] "SAN FRANCISCO" "DENVER"       
 [7] "FRESNO"        "HAYWARD"      
 [9] "HOUSTON"       "RIVERSIDE"    
[11] "SACRAMENTO"    "SAN DIEGO"    
[13] "SAN JOSE"      "SEATTLE"  

```{r}

df4 <- left_join(df3, historical_census_county %>% filter(year == 1980), 
        by = c("County",
               "States" = "State_abb")) %>%
  filter(year == 1980) %>%
  distinct(OEO_fund, poverty_rate, Asian_per, Latino_per, pop_size, Type, category, n, Activism)

```

# Model data 

```{r}

df4 %<>%
  mutate(category = factor(category),
         Activism = factor(Activism),
         Asian_per = as.numeric(Asian_per),
         Latino_per = as.numeric(Latino_per),
         OEO_fund = scales::rescale(OEO_fund, to = c(0,100)),
         pop_size = scales::rescale(pop_size, to = c(0,100)),
         log_n = log(n))
```

OLS AIC:943.463
Logged OLS AIC:335.196
Poisson AIC:739.121
Negative binomial AIC:740.931

```{r}
lm.out <- lm(n ~ OEO_fund + poverty_rate + Asian_per + Latino_per + pop_size + Type + category + Activism, data = df4)

lm_log.out <- lm(log_n ~ OEO_fund + poverty_rate + Asian_per + Latino_per + pop_size + Type + category  + Activism, data = df4)

poisson.out <- glm(n ~ OEO_fund + poverty_rate + Asian_per + Latino_per + pop_size + Type + category + Activism, data = df4, family = "poisson")

nb.out <- MASS::glm.nb(n ~ OEO_fund + poverty_rate + Asian_per + Latino_per + pop_size + Type + category + Activism, data = df4)

```

```{r}
cat(paste0("OLS AIC:", round(AIC(lm.out), 3), "\n",   
           "Logged OLS AIC:", round(AIC(lm_log.out), 3), "\n",
           "Poisson AIC:", round(AIC(poisson.out), 3), "\n",
           "Negative binomial AIC:", round(AIC(nb.out), 3)))
      
```
\begin{table}[!htbp] \centering 
  \caption{} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lcccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{4}{c}{\textit{Dependent variable:}} \\ 
\cline{2-5} 
\\[-1.8ex] & \multicolumn{4}{c}{log\_n} \\ 
\\[-1.8ex] & (1) & (2) & (3) & (4)\\ 
\hline \\[-1.8ex] 
 OEO\_fund & 0.006$^{***}$ & 0.006$^{***}$ & 0.007$^{***}$ & 0.006$^{***}$ \\ 
  & (0.002) & (0.002) & (0.002) & (0.002) \\ 
  & & & & \\ 
 poverty\_rate &  & $-$0.001 & $-$0.004 & $-$0.003 \\ 
  &  & (0.005) & (0.005) & (0.006) \\ 
  & & & & \\ 
 Asian\_per &  &  & 0.002 & 0.002 \\ 
  &  &  & (0.004) & (0.004) \\ 
  & & & & \\ 
 Latino\_per &  &  & 0.007$^{*}$ & 0.004 \\ 
  &  &  & (0.004) & (0.005) \\ 
  & & & & \\ 
 pop\_size &  &  &  & 0.001 \\ 
  &  &  &  & (0.001) \\ 
  & & & & \\ 
 TypeCBO & 0.386$^{***}$ & 0.384$^{***}$ & 0.411$^{***}$ & 0.409$^{***}$ \\ 
  & (0.078) & (0.078) & (0.079) & (0.082) \\ 
  & & & & \\ 
 categoryLatino & $-$0.349$^{***}$ & $-$0.350$^{***}$ & $-$0.336$^{***}$ & $-$0.333$^{***}$ \\ 
  & (0.063) & (0.063) & (0.065) & (0.066) \\ 
  & & & & \\ 
 Activism1 & 0.404$^{***}$ & 0.405$^{***}$ & 0.344$^{***}$ & 0.360$^{***}$ \\ 
  & (0.064) & (0.064) & (0.073) & (0.077) \\ 
  & & & & \\ 
 Constant & $-$0.009 & 0.004 & $-$0.056 & $-$0.069 \\ 
  & (0.102) & (0.121) & (0.127) & (0.129) \\ 
  & & & & \\ 
\hline \\[-1.8ex] 
Observations & 261 & 261 & 261 & 258 \\ 
R$^{2}$ & 0.316 & 0.316 & 0.325 & 0.325 \\ 
Adjusted R$^{2}$ & 0.305 & 0.303 & 0.307 & 0.303 \\ 
Akaike Inf. Crit. & 332.100 & 334.059 & 334.504 & 335.196 \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{4}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 

```{r}

m1 <- lm(log_n ~ OEO_fund + Type + category + Activism, data = df4)
m2 <- lm(log_n ~ OEO_fund + poverty_rate  + Type + category + Activism, data = df4)
m3 <- lm(log_n ~ OEO_fund + poverty_rate + Asian_per + Latino_per  + Type + category + Activism, data = df4)
m4 <- lm(log_n ~ OEO_fund + poverty_rate + Asian_per + Latino_per + pop_size + Type + category + Activism, data = df4)

stargazer::stargazer(add_AIC(m1), add_AIC(m2), add_AIC(m3), add_AIC(m4),
                     keep.stat = c(
                       "AIC", "rsq", "n", "adj.rsq"))

```

