---
title: "Additional robustness check"
author: "Jae Yeon Kim"
output:
html_document:
  toc: True
  theme: united
  number_sections: True
---

# Setup 

```{r, echo=FALSE}

# Import libraries 

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        readstata13, # import stata 13 files 
        tidyverse, # the tidyverse framework
        patchwork, # arranging ggplots 
        ggpubr, # arranging ggplots 
        ggthemes, # fancy ggplot themes
        broom, # modeling
        here, # reproducibility 
        magrittr, # %<>%
        nlme, # GLS
        stargazer, # latex table 
        lmtest,
        sandwich)
  
# devtools::install_github("jaeyk/makereproducible")
library(makereproducible)

# Import R scripts

script_list <- list.files(paste0(here::here(), "/functions"),
  pattern = "*.r|*.R",
  full.names = TRUE
)

for (i in 1:length(script_list))
{
  source(script_list[[i]])
}

# for publication-friendly theme
theme_set(theme_pubr())

```
# Load files and wrangle data 

```{r}

wop_asian_city <- read_csv(here("raw_data", "asian_orgs.csv")) %>%
  filter(F.year <= 1981) %>%
  mutate(County = trimws(County)) %>%
  count(City, County, States, Type) 

wop_latino_city <- read_csv(here("raw_data", "latino_orgs.csv")) %>%
  filter(F.year <= 1981) %>%
  mutate(County = trimws(County)) %>%
  count(City, County, States, Type) 

oeo_census <- read.csv(here("processed_data" , "oeo_census.csv"))

historical_census_county <- read_csv(here("processed_data", "historical_census_county.csv")) %>%
  mutate(County = toupper(County)) %>%
  filter(County != "STATE TOTAL") %>%
  mutate(County = trimws(County)) 

historical_census_county <- add_state_abb(historical_census_county) %>%
    select(State, County, year, poverty_rate, pop_size, State_abb) %>%
  filter(year == 1980)

```

# Merge data

- N of obs: 95 counties 

```{r}

df1 <- merge_by_group(wop_asian_city, wop_latino_city) # 67 counties 

df1$Type[df1$Type == "Hybrid"] <- "CBO"

df2 <- left_join(df1, oeo_census, by = c("County" , "States" , "City"))

df3 <- left_join(df2, historical_census_county, 
        by = c("County",
               "States" = "State_abb"))

```

# Model data 

```{r}

df3 %<>%
  mutate(category = factor(category),
         Asian_per = as.numeric(Asian_per),
         Latino_per = as.numeric(Latino_per),
         OEO_per = round(OEO_fund/sum(df3$OEO_fund),4)*100,
         pop_size = scales::rescale(pop_size, to = c(0,100)),
         log_n = log(n))

df3 <- replace_na(df3, list(Asian_per = 0, Latino_per = 0, OEO_fund = 0, OEO_per = 0, pop_size = 0, poverty_rate = 0))

```

OLS AIC:411.767
Logged OLS AIC:167.075
Poisson AIC:334.545
Negative binomial AIC:335.554

```{r}
lm.out <- lm(n ~ OEO_per + poverty_rate + Asian_per + Latino_per + pop_size + Type + category, data = df3)

lm_log.out <- lm(log_n ~ OEO_per + poverty_rate + Asian_per + Latino_per + pop_size + Type + category, data = df3)

poisson.out <- glm(n ~ OEO_per + poverty_rate + Asian_per + Latino_per + pop_size + Type + category, data = df3, family = "poisson")

nb.out <- MASS::glm.nb(n ~ OEO_per + poverty_rate + Asian_per + Latino_per + pop_size + Type + category, data = df3)

```

```{r}
cat(paste0("OLS AIC:", round(AIC(lm.out), 3), "\n",   
           "Logged OLS AIC:", round(AIC(lm_log.out), 3), "\n",
           "Poisson AIC:", round(AIC(poisson.out), 3), "\n",
           "Negative binomial AIC:", round(AIC(nb.out), 3)))
      
```
\begin{table}[!htbp] \centering 
  \caption{} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lcccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{4}{c}{\textit{Dependent variable:}} \\ 
\cline{2-5} 
\\[-1.8ex] & \multicolumn{3}{c}{log\_n} &   \\ 
\\[-1.8ex] & \multicolumn{3}{c}{\textit{OLS}} & \textit{coefficient} \\ 
 & \multicolumn{3}{c}{\textit{}} & \textit{test} \\ 
\\[-1.8ex] & (1) & (2) & (3) & (4)\\ 
\hline \\[-1.8ex] 
 OEO\_per & 0.141$^{**}$ & 0.138$^{**}$ & 0.134$^{**}$ & 0.134$^{*}$ \\ 
  & (0.059) & (0.058) & (0.059) & (0.070) \\ 
  & & & & \\ 
 TypeCBO & 0.177 & 0.207 & 0.233$^{*}$ & 0.233$^{*}$ \\ 
  & (0.135) & (0.136) & (0.140) & (0.129) \\ 
  & & & & \\ 
 categoryLatino & $-$0.270$^{**}$ & $-$0.215$^{**}$ & $-$0.238$^{**}$ & $-$0.238$^{*}$ \\ 
  & (0.104) & (0.108) & (0.111) & (0.124) \\ 
  & & & & \\ 
 Asian\_per &  & 0.011 & 0.011 & 0.011 \\ 
  &  & (0.007) & (0.007) & (0.013) \\ 
  & & & & \\ 
 Latino\_per &  & 0.003 & 0.008 & 0.008 \\ 
  &  & (0.005) & (0.007) & (0.007) \\ 
  & & & & \\ 
 poverty\_rate &  &  & $-$0.007 & $-$0.007 \\ 
  &  &  & (0.010) & (0.010) \\ 
  & & & & \\ 
 pop\_size &  &  & $-$0.002 & $-$0.002 \\ 
  &  &  & (0.002) & (0.002) \\ 
  & & & & \\ 
 Constant & 0.183 & 0.040 & 0.094 & 0.094 \\ 
  & (0.164) & (0.185) & (0.211) & (0.202) \\ 
  & & & & \\ 
\hline \\[-1.8ex] 
Observations & 111 & 111 & 111 &  \\ 
R$^{2}$ & 0.126 & 0.154 & 0.161 &  \\ 
Adjusted R$^{2}$ & 0.101 & 0.113 & 0.104 &  \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{4}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table} 

```{r}

m1 <- lm(log_n ~ OEO_per + Type + category, data = df3)

m2 <- lm(log_n ~ OEO_per + Type + category + Asian_per + Latino_per, data = df3)

m3 <- lm(log_n ~ OEO_per + Type + category + Asian_per + Latino_per + poverty_rate + pop_size, data = df3)

lm_white <- coeftest(m4, vcov = vcovHC(m4, type = "HC0"))

stargazer::stargazer(m1, m2, m3, lm_white,
                     keep.stat = c(
                       "rsq", "n", "adj.rsq"))

```

